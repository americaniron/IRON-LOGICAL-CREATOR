import React, { createContext, ReactNode, useMemo, useCallback, useRef, useEffect } from 'react';
import { usePersistentState } from '../hooks/usePersistentState';

interface ConfigContextType {
  safeMode: boolean;
  setSafeMode: (value: boolean) => void;
  visualInterference: boolean;
  setVisualInterference: (value: boolean) => void;
  audioFeedback: boolean;
  setAudioFeedback: (value: boolean) => void;
  devMode: boolean;
  setDevMode: (value: boolean) => void;
  playFeedback: (sound: 'click' | 'error' | 'success' | 'notification') => void;
}

export const ConfigContext = createContext<ConfigContextType>({} as ConfigContextType);

// Base64 encoded sound effects to avoid extra file requests
const SOUNDS = {
  click: 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+'JvT19FAAAAAAD//wA/D/4PAg4E/g8BDgA5Af8KAA4A/wEIAh4AFAEGAP0A/wQAAAUAAwAA/wEAAAEAAwD/AP8AAAD8AP8A/wD+AAAA/AD/AP8A/wAAAQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABAAAAAAD/AQABadd ai',
  error: 'data:audio/wav;base64,UklGRq4CAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YXsDAACAgICAwMDAv7+/uLi4sbGxq6urpqampaWlpKSkoaGhoZ+fn56enp2dnZubm5qampmZmZiYmJeXl5aWlpWVlZSUlJOTk5KSkpGRkZCQkI+Pj46Ojo2NjYyMjIyLi4uKiYmJiYiIiIiHh4eGhoaFhYWDg4N+fn58fHx6enp4eHh2dnZ0dHRycnJwcHBubm5sbGxqampoaGhpaWlqampra2tsbGxubm5wcHBxcXFycnJ0dHR1dXV3d3d5eXl7e3t9fX1/f3+AgYKDg4SGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqqusra6vsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/wACAgIEBAQGBggKCgwODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDg4SGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqqusra6vsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w==',
  success: 'data:audio/wav;base64,UklGRkgCAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YVADAgAAAAAAAgMEBQYICQoLDQ4PEBESExQVFhcYGRobHB0eHyAhIiMkJSYnKCkqKywtLi8wMTIzNDU2Nzg5Ojs8PT4/QEFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaW1xdXl9gYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXp7fH1+f4CBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6foKGio6SlpqeoqaqrrK2ur7Gys7S1tre4ubq7vL2+v8DBwsPExcbHyMnKy8zNzs/Q0dLT1NXW19jZ2tvc3d7f4OHi4+Tl5ufo6err7O3u7/Dx8vP09fb3+Pn6+/z9/v8AAQECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDg4SGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqqusra6vsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w==',
  notification: 'data:audio/wav;base64,UklGRlACAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YVACAACAgICAgICdnZ2ZmZmYmJiXl5eWlpaVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZWVlZ-wA==',
};

export const ConfigProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [safeMode, setSafeMode] = usePersistentState<boolean>('IRON_safeMode', false);
  const [visualInterference, setVisualInterference] = usePersistentState<boolean>('IRON_visualInterference', true);
  const [audioFeedback, setAudioFeedback] = usePersistentState<boolean>('IRON_audioFeedback', true);
  const [devMode, setDevMode] = usePersistentState<boolean>('IRON_devMode', false);

  const audioRefs = useRef<{ [key: string]: HTMLAudioElement | null }>({});

  useEffect(() => {
    document.body.classList.toggle('flicker-active', !safeMode);
    document.body.classList.toggle('interference-active', visualInterference && !safeMode);
  }, [safeMode, visualInterference]);

  const playFeedback = useCallback((sound: keyof typeof SOUNDS) => {
    if (audioFeedback) {
      if (!audioRefs.current[sound]) {
        audioRefs.current[sound] = new Audio(SOUNDS[sound]);
      }
      audioRefs.current[sound]?.play().catch(e => console.error("Audio playback error:", e));
    }
  }, [audioFeedback]);

  const value = useMemo(() => ({
    safeMode,
    setSafeMode,
    visualInterference,
    setVisualInterference,
    audioFeedback,
    setAudioFeedback,
    devMode,
    setDevMode,
    playFeedback
  }), [safeMode, setSafeMode, visualInterference, setVisualInterference, audioFeedback, setAudioFeedback, devMode, setDevMode, playFeedback]);

  return <ConfigContext.Provider value={value}>{children}</ConfigContext.Provider>;
};
